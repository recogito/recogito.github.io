# Local Development Setup - Issues & Solutions Log

**Purpose**: Track issues encountered during local dev setup and their solutions. This is a working document to help refine the public-facing documentation.

**Date Started**: 2025-10-04

---

## Setup Session Log

### Step 1: Install System Prerequisites

**Status**: Partial - Supabase CLI installed, Docker requires manual installation

**Pre-existing Software**:
- ✅ Node.js v20.10.0
- ✅ npm 10.8.2
- ✅ Git 2.50.1
- ✅ Homebrew 4.6.15

**Issues**:
- Docker Desktop installation via `brew install --cask docker` requires sudo password for creating `/usr/local/cli-plugins` directory
- Installation fails in non-interactive terminal environment

**Solutions**:
- Supabase CLI: Successfully installed via `brew install supabase/tap/supabase` (v2.48.3)
- Docker Desktop: User needs to install manually via:
  - Option 1: Run `brew install --cask docker` in their terminal with sudo access
  - Option 2: Download from https://www.docker.com/products/docker-desktop/
  - After installation, launch Docker Desktop from Applications to start the daemon

**Documentation Updates Needed**:
- Note that Docker Desktop installation may require manual intervention
- Add verification step after installation to ensure Docker daemon is running

---

### Step 2: Set Up Supabase Local Development Environment

**Status**: ✅ Completed

**Issues**:
- `supabase start` fails during migration `20230524173605_remote_commit.sql`
- Error: `schema "pgsodium" does not exist (SQLSTATE 3F000)`
- The migration tries to create extension in pgsodium schema before the schema is created
- This appears to be a migration ordering issue

**Root Cause Analysis**:
- The migration file `20230524173605_remote_commit.sql` was exported from production Supabase
- Production Supabase pre-creates the `pgsodium` schema automatically
- Local Supabase does NOT pre-create this schema
- Migration line 13: `CREATE EXTENSION IF NOT EXISTS "pgsodium" WITH SCHEMA "pgsodium";` fails because schema doesn't exist

**Solution Approach - REJECTED**:
- Initial idea: Modify migration file to remove `WITH SCHEMA` clause
- **WHY REJECTED**: Migrations are immutable historical records, must work in all environments
- Modifying migrations would break staging/production deployments

**Correct Solution Investigation**:
- Need to handle environment difference at configuration level, not migration level
- Options to explore:
  1. Pre-migration SQL in Supabase config (seed-like, but for schema setup)
  2. Environment-specific initialization script
  3. Supabase local config to enable pgsodium/graphql schemas before migrations
  4. Check if newer Supabase CLI versions handle this automatically
- Looking for Supabase-native way to pre-create these schemas in local dev

**Final Solution - Local Dev Only**:
- **Analysis**: Searched codebase - Recogito does NOT use pgsodium encryption features
  - pgsodium only appears in initial migration (auto-generated by Supabase dump)
  - No code references pgsodium functions
  - Supabase is deprecating pgsodium for new projects (CLI >= 2.20.4)
- **Solution**: Commented out pgsodium extension line in migration file
- **Why this works**: Extension not needed, Supabase recommends removing for newer PostgreSQL versions

**IMPORTANT - Non-Local Environment Consideration**:
- ⚠️ Modifying migration files is NOT a proper solution for staging/production environments
- This change works for local dev but needs proper handling for:
  - Existing deployments that may have pgsodium installed
  - Migration history consistency across environments
  - Potential rollback scenarios
- **ACTION NEEDED**: Determine proper setup procedure for non-local environments
  - Option 1: Keep pgsodium for production (if already installed), remove for new local setups
  - Option 2: Create environment-specific migration handling
  - Option 3: Update all environments to remove pgsodium dependency
- See: https://github.com/supabase/cli/issues/3358 for ongoing discussion

**Test Results**:
- ✅ Supabase started successfully with commented-out pgsodium extension
- All services running:
  - API URL: http://127.0.0.1:54321
  - Database URL: postgresql://postgres:postgres@127.0.0.1:54322/postgres
  - Studio URL: http://127.0.0.1:54323
  - GraphQL URL: http://127.0.0.1:54321/graphql/v1
- No errors in migration execution

**Documentation Updates Needed**:
- Update local dev guide with pgsodium fix instructions
- Add note about Supabase CLI version compatibility (>= 2.20.4)
- Document the one-time setup step to comment out pgsodium

---

### Step 3: Run Database Migrations

**Status**: ✅ Completed

**Issues**:
- Initially ran `supabase start` but migrations were not auto-applied
- Database had no tables in public schema

**Solutions**:
- Running `supabase db reset` applies all migrations and seeds
- This creates the complete database schema with all tables, policies, functions

**Test Results**:
- ✅ All 156 migrations applied successfully
- ✅ Database schema populated with tables: projects, layers, contexts, annotations, bodies, targets, profiles, organization_groups, project_groups, layer_groups, documents, collections, etc.
- ✅ Supabase Studio shows all tables at http://localhost:54323

**Documentation Updates Needed**:
- Clarify in guide that `supabase start` doesn't auto-apply migrations
- Document that `supabase db reset` is needed to apply migrations

---

### Step 4: Create Test Users

**Status**: ✅ Completed

**Issues**:
- Original SQL file at `SQL Scripts/table population/create_test_users.sql` had multiple issues:
  - Wrapped in backticks (invalid SQL syntax)
  - Missing `provider_id` column in auth.identities INSERT
  - Outdated schema (auth.identities schema changed)
  - Syntax error in reader email (double backticks)

**Solutions**:
- Created corrected SQL file: `create_test_users_fixed.sql`
- Updated identities INSERT to use `provider_id` as first column (required, non-null)
- Removed backticks wrapping
- Fixed email syntax error

**Test Results**:
- ✅ 4 test users created successfully:
  - professor@example.com (ID: 35fb1d77-cb20-41c4-81c0-d344a0c641b8)
  - tutor@example.com (ID: 643b574b-5673-4839-8f5e-116d551a7103)
  - student@example.com (ID: 4fb7ae8c-51fe-4f4d-9f96-083543d4d75f)
  - reader@example.com (ID: dfd9e45c-a435-4e55-9082-10ff52b0f5e2)
- ✅ Users visible in Supabase Studio under Authentication

**Documentation Updates Needed**:
- Update guide to use the corrected SQL file
- Document the test user credentials (passwords are bcrypt hashed in SQL)
- Note: Need to find/document the actual passwords for these test users

---

### Step 5: Clone recogito-server Repository

**Status**: Already completed (repo already cloned)

**Issues**:
- None

**Solutions**:
- Repository was already cloned at ~/repos/recogito-server

**Documentation Updates Needed**:
- None

---

### Step 4: Run Supabase Migrations

**Status**: Not started

**Issues**:
-

**Solutions**:
-

**Documentation Updates Needed**:
-

---

### Step 5: Create and Populate Test Users

**Status**: Not started

**Issues**:
-

**Solutions**:
-

**Documentation Updates Needed**:
-

---

### Step 6: Clone recogito-config Repository

**Status**: Not started

**Issues**:
-

**Solutions**:
-

**Documentation Updates Needed**:
-

---

### Step 7: Set Up recogito-config Tool Environment

**Status**: Not started

**Issues**:
-

**Solutions**:
-

**Documentation Updates Needed**:
-

---

### Step 8: Generate Configuration File

**Status**: Not started

**Issues**:
-

**Solutions**:
-

**Documentation Updates Needed**:
-

---

### Step 9: Clone recogito-client Repository

**Status**: Not started

**Issues**:
-

**Solutions**:
-

**Documentation Updates Needed**:
-

---

### Step 10: Configure Client Environment Variables

**Status**: Not started

**Issues**:
-

**Solutions**:
-

**Documentation Updates Needed**:
-

---

### Step 11: Deploy Configuration File to Client

**Status**: Not started

**Issues**:
-

**Solutions**:
-

**Documentation Updates Needed**:
-

---

### Step 12: Install Client Dependencies and Start Dev Server

**Status**: Not started

**Issues**:
-

**Solutions**:
-

**Documentation Updates Needed**:
-

---

### Step 13: Verify Complete Stack

**Status**: Not started

**Issues**:
-

**Solutions**:
-

**Documentation Updates Needed**:
-

---

### Step 14: Test Authentication and Basic Functionality

**Status**: Not started

**Issues**:
-

**Solutions**:
-

**Documentation Updates Needed**:
-

---

## Summary of Documentation Changes

### Guide Updates
- **local-development.mdx**: Added Supabase CLI compatibility note in Phase 1, Step 1
  - Explains pgsodium extension issue with CLI >= 2.20.4
  - Provides clear instructions to comment out the extension line
  - Links to reasoning (extension not used by Recogito)

### Reference Page Updates
- None required (pgsodium not mentioned in reference docs)

### New Reference Pages Created
- None required

### Migration File Changes
- **recogito-server/supabase/migrations/20230524173605_remote_commit.sql**:
  - Commented out pgsodium extension creation (line 13)
  - Added explanation comments about CLI compatibility
  - Added GitHub issue reference for context

---

## Notes

-
